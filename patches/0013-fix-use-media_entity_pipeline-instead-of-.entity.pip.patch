From 7f1afd65df440f07b16818262336628d82248982 Mon Sep 17 00:00:00 2001
From: ruslanbay <67730802+ruslanbay@users.noreply.github.com>
Date: Fri, 28 Nov 2025 15:58:40 +0100
Subject: [PATCH 13/16] fix: use media_entity_pipeline instead of .entity.pipe

https://github.com/intel/linux-intel-lts/blob/lts-v6.1.120-linux-241226T022850Z/drivers/media/pci/intel/ipu-isys-csi2.c#L288
---
 .../media/pci/intel/ipu-isys-csi2-be-soc.c    |  2 +-
 drivers/media/pci/intel/ipu-isys-csi2-be.c    |  2 +-
 drivers/media/pci/intel/ipu-isys-csi2.c       | 19 +++++++++----------
 drivers/media/pci/intel/ipu-isys-queue.c      | 16 ++++++++--------
 drivers/media/pci/intel/ipu-isys-subdev.c     |  2 +-
 drivers/media/pci/intel/ipu-isys-video.c      | 18 +++++++++---------
 drivers/media/pci/intel/ipu4/ipu4-isys-csi2.c |  2 +-
 drivers/media/pci/intel/ipu4/ipu4-isys-isa.c  |  6 +++---
 8 files changed, 33 insertions(+), 34 deletions(-)

diff --git a/drivers/media/pci/intel/ipu-isys-csi2-be-soc.c b/drivers/media/pci/intel/ipu-isys-csi2-be-soc.c
index 7fd69ec40..2d6a1bc30 100644
--- a/drivers/media/pci/intel/ipu-isys-csi2-be-soc.c
+++ b/drivers/media/pci/intel/ipu-isys-csi2-be-soc.c
@@ -70,7 +70,7 @@ __subdev_link_validate(struct v4l2_subdev *sd, struct media_link *link,
 		       struct v4l2_subdev_format *source_fmt,
 		       struct v4l2_subdev_format *sink_fmt)
 {
-	struct ipu_isys_pipeline *ip = container_of(sd->entity.pipe,
+	struct ipu_isys_pipeline *ip = container_of(media_entity_pipeline(&sd->entity),
 						    struct ipu_isys_pipeline,
 						    pipe);
 
diff --git a/drivers/media/pci/intel/ipu-isys-csi2-be.c b/drivers/media/pci/intel/ipu-isys-csi2-be.c
index 3f1edc34b..bbf1b3ff5 100644
--- a/drivers/media/pci/intel/ipu-isys-csi2-be.c
+++ b/drivers/media/pci/intel/ipu-isys-csi2-be.c
@@ -66,7 +66,7 @@ static int __subdev_link_validate(struct v4l2_subdev *sd,
 				  struct v4l2_subdev_format *source_fmt,
 				  struct v4l2_subdev_format *sink_fmt)
 {
-	struct ipu_isys_pipeline *ip = container_of(sd->entity.pipe,
+	struct ipu_isys_pipeline *ip = container_of(media_entity_pipeline(&sd->entity),
 						    struct ipu_isys_pipeline,
 						    pipe);
 
diff --git a/drivers/media/pci/intel/ipu-isys-csi2.c b/drivers/media/pci/intel/ipu-isys-csi2.c
index 5472ea764..79cb52692 100644
--- a/drivers/media/pci/intel/ipu-isys-csi2.c
+++ b/drivers/media/pci/intel/ipu-isys-csi2.c
@@ -92,7 +92,7 @@ static struct v4l2_subdev_internal_ops csi2_sd_internal_ops = {
 
 int ipu_isys_csi2_get_link_freq(struct ipu_isys_csi2 *csi2, __s64 *link_freq)
 {
-	struct ipu_isys_pipeline *pipe = container_of(csi2->asd.sd.entity.pipe,
+	struct ipu_isys_pipeline *pipe = container_of(media_entity_pipeline(&csi2->asd.sd.entity),
 						      struct ipu_isys_pipeline,
 						      pipe);
 	struct v4l2_subdev *ext_sd =
@@ -159,7 +159,7 @@ static void csi2_meta_prepare_firmware_stream_cfg_default(
 			struct ipu_fw_isys_stream_cfg_data_abi *cfg)
 {
 	struct ipu_isys_pipeline *ip =
-	    to_ipu_isys_pipeline(av->vdev.entity.pipe);
+	    to_ipu_isys_pipeline(media_entity_pipeline(&av->vdev.entity));
 	struct ipu_isys_queue *aq = &av->aq;
 	struct ipu_fw_isys_output_pin_info_abi *pin_info;
 	struct v4l2_mbus_frame_desc_entry entry;
@@ -297,7 +297,7 @@ ipu_isys_csi2_calc_timing(struct ipu_isys_csi2 *csi2,
 static int set_stream(struct v4l2_subdev *sd, int enable)
 {
 	struct ipu_isys_csi2 *csi2 = to_ipu_isys_csi2(sd);
-	struct ipu_isys_pipeline *ip = container_of(sd->entity.pipe,
+	struct ipu_isys_pipeline *ip = container_of(media_entity_pipeline(&sd->entity),
 						    struct ipu_isys_pipeline,
 						    pipe);
 	struct ipu_isys_csi2_config *cfg;
@@ -373,6 +373,7 @@ static void csi2_capture_done(struct ipu_isys_pipeline *ip,
 
 static int csi2_link_validate(struct media_link *link)
 {
+	struct media_pipeline *media_pipe;
 	struct ipu_isys_csi2 *csi2;
 	struct ipu_isys_pipeline *ip;
 	struct v4l2_subdev_route r[IPU_ISYS_MAX_STREAMS];
@@ -384,17 +385,15 @@ static int csi2_link_validate(struct media_link *link)
 	int i;
 	int rval;
 
-	if (!link->sink->entity ||
-	    !link->sink->entity->pipe || !link->source->entity)
+	media_pipe = media_entity_pipeline(link->sink->entity);
+	if (!media_pipe)
 		return -EINVAL;
 	csi2 =
 	    to_ipu_isys_csi2(media_entity_to_v4l2_subdev(link->sink->entity));
-	ip = to_ipu_isys_pipeline(link->sink->entity->pipe);
+	ip = to_ipu_isys_pipeline(media_pipe);
 	csi2->receiver_errors = 0;
 	ip->csi2 = csi2;
-	ipu_isys_video_add_capture_done(to_ipu_isys_pipeline
-					(link->sink->entity->pipe),
-					csi2_capture_done);
+	ipu_isys_video_add_capture_done(ip, csi2_capture_done);
 
 	rval = v4l2_subdev_link_validate(link);
 	if (rval)
@@ -492,7 +491,7 @@ static int __subdev_link_validate(struct v4l2_subdev *sd,
 				  struct v4l2_subdev_format *source_fmt,
 				  struct v4l2_subdev_format *sink_fmt)
 {
-	struct ipu_isys_pipeline *ip = container_of(sd->entity.pipe,
+	struct ipu_isys_pipeline *ip = container_of(media_entity_pipeline(&sd->entity),
 						    struct ipu_isys_pipeline,
 						    pipe);
 
diff --git a/drivers/media/pci/intel/ipu-isys-queue.c b/drivers/media/pci/intel/ipu-isys-queue.c
index ca8c36cbb..26067ba05 100644
--- a/drivers/media/pci/intel/ipu-isys-queue.c
+++ b/drivers/media/pci/intel/ipu-isys-queue.c
@@ -644,7 +644,7 @@ static void __buf_queue(struct vb2_buffer *vb, bool force)
 	struct ipu_isys_video *av = ipu_isys_queue_to_video(aq);
 	struct ipu_isys_buffer *ib = vb2_buffer_to_ipu_isys_buffer(vb);
 	struct ipu_isys_pipeline *ip =
-	    to_ipu_isys_pipeline(av->vdev.entity.pipe);
+	    to_ipu_isys_pipeline(media_entity_pipeline(&av->vdev.entity));
 	struct ipu_isys_buffer_list bl;
 
 	struct ipu_fw_isys_frame_buff_set_abi *buf = NULL;
@@ -889,7 +889,7 @@ static int start_streaming(struct vb2_queue *q, unsigned int count)
 
 	mutex_lock(&av->isys->stream_mutex);
 
-	first = !av->vdev.entity.pipe;
+	first = !media_entity_pipeline(&av->vdev.entity);
 
 	if (first) {
 		rval = ipu_isys_video_prepare_streaming(av, 1);
@@ -907,7 +907,7 @@ static int start_streaming(struct vb2_queue *q, unsigned int count)
 		goto out_unprepare_streaming;
 	}
 
-	ip = to_ipu_isys_pipeline(av->vdev.entity.pipe);
+	ip = to_ipu_isys_pipeline(media_entity_pipeline(&av->vdev.entity));
 	pipe_av = container_of(ip, struct ipu_isys_video, ip);
 	mutex_unlock(&av->mutex);
 
@@ -964,7 +964,7 @@ static void stop_streaming(struct vb2_queue *q)
 	struct ipu_isys_queue *aq = vb2_queue_to_ipu_isys_queue(q);
 	struct ipu_isys_video *av = ipu_isys_queue_to_video(aq);
 	struct ipu_isys_pipeline *ip =
-	    to_ipu_isys_pipeline(av->vdev.entity.pipe);
+	    to_ipu_isys_pipeline(media_entity_pipeline(&av->vdev.entity));
 	struct ipu_isys_video *pipe_av =
 	    container_of(ip, struct ipu_isys_video, ip);
 
@@ -1044,7 +1044,7 @@ ipu_isys_buf_calc_sequence_time(struct ipu_isys_buffer *ib,
 	struct ipu_isys_queue *aq = vb2_queue_to_ipu_isys_queue(vb->vb2_queue);
 	struct ipu_isys_video *av = ipu_isys_queue_to_video(aq);
 	struct ipu_isys_pipeline *ip =
-	    to_ipu_isys_pipeline(av->vdev.entity.pipe);
+	    to_ipu_isys_pipeline(media_entity_pipeline(&av->vdev.entity));
 	u64 ns;
 	u32 sequence;
 
@@ -1302,18 +1302,18 @@ void ipu_isys_req_queue(struct media_request *req)
 			av->vdev.name, vb->
 			index);
 		if (!pipe) {
-			if (!av->vdev.entity.pipe) {
+			if (!media_entity_pipeline(&av->vdev.entity)) {
 				no_pipe = true;
 				continue;
 			}
 
-			pipe = av->vdev.entity.pipe;
+			pipe = media_entity_pipeline(&av->vdev.entity);
 			dev_dbg(&isys->adev->dev, "%s: pipe %p\n",
 				av->vdev.name, pipe);
 			continue;
 		}
 
-		if (av->vdev.entity.pipe != pipe) {
+		if (media_entity_pipeline(&av->vdev.entity) != pipe) {
 			dev_dbg(&isys->adev->dev,
 				"%s: request includes buffers in multiple pipelines\n",
 				req->debug_str);
diff --git a/drivers/media/pci/intel/ipu-isys-subdev.c b/drivers/media/pci/intel/ipu-isys-subdev.c
index 724cde38d..8cf17820f 100644
--- a/drivers/media/pci/intel/ipu-isys-subdev.c
+++ b/drivers/media/pci/intel/ipu-isys-subdev.c
@@ -772,7 +772,7 @@ int ipu_isys_subdev_link_validate(struct v4l2_subdev *sd,
 {
 	struct v4l2_subdev *source_sd =
 	    media_entity_to_v4l2_subdev(link->source->entity);
-	struct ipu_isys_pipeline *ip = container_of(sd->entity.pipe,
+	struct ipu_isys_pipeline *ip = container_of(media_entity_pipeline(&sd->entity),
 						    struct ipu_isys_pipeline,
 						    pipe);
 	struct ipu_isys_subdev *asd = to_ipu_isys_subdev(sd);
diff --git a/drivers/media/pci/intel/ipu-isys-video.c b/drivers/media/pci/intel/ipu-isys-video.c
index 8c63afa7e..08dd50329 100644
--- a/drivers/media/pci/intel/ipu-isys-video.c
+++ b/drivers/media/pci/intel/ipu-isys-video.c
@@ -663,7 +663,7 @@ static int link_validate(struct media_link *link)
 	    container_of(link->sink, struct ipu_isys_video, pad);
 	/* All sub-devices connected to a video node are ours. */
 	struct ipu_isys_pipeline *ip =
-		to_ipu_isys_pipeline(av->vdev.entity.pipe);
+		to_ipu_isys_pipeline(media_entity_pipeline(&av->vdev.entity));
 	struct v4l2_subdev_route r[IPU_ISYS_MAX_STREAMS];
 	struct v4l2_subdev_routing routing = {
 		.routes = r,
@@ -732,7 +732,7 @@ static void put_stream_opened(struct ipu_isys_video *av)
 static int get_stream_handle(struct ipu_isys_video *av)
 {
 	struct ipu_isys_pipeline *ip =
-	    to_ipu_isys_pipeline(av->vdev.entity.pipe);
+	    to_ipu_isys_pipeline(media_entity_pipeline(&av->vdev.entity));
 	unsigned int stream_handle;
 	unsigned long flags;
 
@@ -754,7 +754,7 @@ static int get_stream_handle(struct ipu_isys_video *av)
 static void put_stream_handle(struct ipu_isys_video *av)
 {
 	struct ipu_isys_pipeline *ip =
-	    to_ipu_isys_pipeline(av->vdev.entity.pipe);
+	    to_ipu_isys_pipeline(media_entity_pipeline(&av->vdev.entity));
 	unsigned long flags;
 
 	spin_lock_irqsave(&av->isys->lock, flags);
@@ -912,7 +912,7 @@ void ipu_isys_prepare_firmware_stream_cfg_default(
 			struct ipu_fw_isys_stream_cfg_data_abi *cfg)
 {
 	struct ipu_isys_pipeline *ip =
-	    to_ipu_isys_pipeline(av->vdev.entity.pipe);
+	    to_ipu_isys_pipeline(media_entity_pipeline(&av->vdev.entity));
 	struct ipu_isys_queue *aq = &av->aq;
 	struct ipu_fw_isys_output_pin_info_abi *pin_info;
 #if !defined(CONFIG_VIDEO_INTEL_IPU4) && !defined(CONFIG_VIDEO_INTEL_IPU4P)
@@ -1052,7 +1052,7 @@ static int start_stream_firmware(struct ipu_isys_video *av,
 				 struct ipu_isys_buffer_list *bl)
 {
 	struct ipu_isys_pipeline *ip =
-	    to_ipu_isys_pipeline(av->vdev.entity.pipe);
+	    to_ipu_isys_pipeline(media_entity_pipeline(&av->vdev.entity));
 	struct device *dev = &av->isys->adev->dev;
 	struct v4l2_subdev_selection sel_fmt = {
 		.which = V4L2_SUBDEV_FORMAT_ACTIVE,
@@ -1292,7 +1292,7 @@ static int start_stream_firmware(struct ipu_isys_video *av,
 static void stop_streaming_firmware(struct ipu_isys_video *av)
 {
 	struct ipu_isys_pipeline *ip =
-	    to_ipu_isys_pipeline(av->vdev.entity.pipe);
+	    to_ipu_isys_pipeline(media_entity_pipeline(&av->vdev.entity));
 	struct device *dev = &av->isys->adev->dev;
 	int rval, tout;
 	enum ipu_fw_isys_send_type send_type =
@@ -1325,7 +1325,7 @@ static void stop_streaming_firmware(struct ipu_isys_video *av)
 static void close_streaming_firmware(struct ipu_isys_video *av)
 {
 	struct ipu_isys_pipeline *ip =
-	    to_ipu_isys_pipeline(av->vdev.entity.pipe);
+	    to_ipu_isys_pipeline(media_entity_pipeline(&av->vdev.entity));
 	struct device *dev = &av->isys->adev->dev;
 	int rval, tout;
 
@@ -1392,7 +1392,7 @@ int ipu_isys_video_prepare_streaming(struct ipu_isys_video *av,
 	dev_dbg(dev, "prepare stream: %d\n", state);
 
 	if (!state) {
-		ip = to_ipu_isys_pipeline(av->vdev.entity.pipe);
+		ip = to_ipu_isys_pipeline(media_entity_pipeline(&av->vdev.entity));
 
 		if (ip->interlaced && isys->short_packet_source ==
 		    IPU_ISYS_SHORT_PACKET_FROM_RECEIVER)
@@ -1516,7 +1516,7 @@ int ipu_isys_video_set_streaming(struct ipu_isys_video *av,
 
 	struct media_entity *entity, *entity2;
 	struct ipu_isys_pipeline *ip =
-	    to_ipu_isys_pipeline(av->vdev.entity.pipe);
+	    to_ipu_isys_pipeline(media_entity_pipeline(&av->vdev.entity));
 	struct v4l2_subdev *sd, *esd;
 	int rval = 0;
 
diff --git a/drivers/media/pci/intel/ipu4/ipu4-isys-csi2.c b/drivers/media/pci/intel/ipu4/ipu4-isys-csi2.c
index 50eb7a9ab..b973e4155 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-isys-csi2.c
+++ b/drivers/media/pci/intel/ipu4/ipu4-isys-csi2.c
@@ -452,7 +452,7 @@ int ipu_isys_csi2_set_stream(struct v4l2_subdev *sd,
 			     unsigned int nlanes, int enable)
 {
 	struct ipu_isys_csi2 *csi2 = to_ipu_isys_csi2(sd);
-	struct ipu_isys_pipeline *ip = container_of(sd->entity.pipe,
+	struct ipu_isys_pipeline *ip = container_of(media_entity_pipeline(&sd->entity),
 						    struct ipu_isys_pipeline,
 						    pipe);
 	unsigned int i;
diff --git a/drivers/media/pci/intel/ipu4/ipu4-isys-isa.c b/drivers/media/pci/intel/ipu4/ipu4-isys-isa.c
index f93dff3ad..4ac6545ec 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-isys-isa.c
+++ b/drivers/media/pci/intel/ipu4/ipu4-isys-isa.c
@@ -218,7 +218,7 @@ static int isa_link_validate(struct media_link *link)
 	if (is_media_entity_v4l2_subdev(link->source->entity))
 		return v4l2_subdev_link_validate(link);
 
-	pipe = link->sink->entity->pipe;
+	pipe = media_entity_pipeline(link->sink->entity);
 	ip = to_ipu_isys_pipeline(pipe);
 	ip->nr_queues++;
 
@@ -350,7 +350,7 @@ static void isa_capture_done(struct ipu_isys_pipeline *ip,
 
 	aq = &isa->av_3a.aq;
 
-	if (isa->av_3a.vdev.entity.pipe != isa->av_config.vdev.entity.pipe) {
+	if (media_entity_pipeline(&isa->av_3a.vdev.entity) != media_entity_pipeline(&isa->av_config.vdev.entity)) {
 		dev_dbg(&ip->isys->adev->dev, "3a disabled\n");
 		return;
 	}
@@ -493,7 +493,7 @@ isa_prepare_firmware_stream_cfg_param(struct ipu_isys_video *av,
 {
 	struct ipu_isys_isa *isa = &av->isys->isa;
 	struct ipu_isys_pipeline *ip =
-	    to_ipu_isys_pipeline(av->vdev.entity.pipe);
+	    to_ipu_isys_pipeline(media_entity_pipeline(&av->vdev.entity));
 
 	cfg->isa_cfg.cfg.blc = !!(isa->isa_en->val & V4L2_IPU_ISA_EN_BLC);
 	cfg->isa_cfg.cfg.lsc = !!(isa->isa_en->val & V4L2_IPU_ISA_EN_LSC);
-- 
2.34.1

