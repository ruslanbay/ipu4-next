From 89d2f3c533573770ad26a3bd2d2026ee442d2753 Mon Sep 17 00:00:00 2001
From: ruslanbay <67730802+ruslanbay@users.noreply.github.com>
Date: Thu, 27 Nov 2025 22:37:21 +0100
Subject: [PATCH 04/16] add IPU4, IPU4P and crlmodule related files to
 /include/media

---
 include/media/as3638.h         | 33 ++++++++++++++++
 include/media/crlmodule.h      | 70 ++++++++++++++++++++++++++++++++++
 include/media/dw9714.h         | 32 ++++++++++++++++
 include/media/ipu-isys.h       | 38 ++++++++++++++++++
 include/media/ipu4-acpi.h      | 27 +++++++++++++
 include/media/lc898122.h       | 14 +++++++
 include/media/lm3643.h         | 50 ++++++++++++++++++++++++
 include/media/max9286.h        | 53 +++++++++++++++++++++++++
 include/media/ti960.h          | 67 ++++++++++++++++++++++++++++++++
 include/media/ti964.h          | 59 ++++++++++++++++++++++++++++
 include/media/v4l2-subdev.h    | 19 +++++++++
 include/media/videobuf2-v4l2.h | 17 +++++++++
 12 files changed, 479 insertions(+)
 create mode 100644 include/media/as3638.h
 create mode 100644 include/media/crlmodule.h
 create mode 100644 include/media/dw9714.h
 create mode 100644 include/media/ipu-isys.h
 create mode 100644 include/media/ipu4-acpi.h
 create mode 100644 include/media/lc898122.h
 create mode 100644 include/media/lm3643.h
 create mode 100644 include/media/max9286.h
 create mode 100644 include/media/ti960.h
 create mode 100644 include/media/ti964.h

diff --git a/include/media/as3638.h b/include/media/as3638.h
new file mode 100644
index 000000000..8e847efaa
--- /dev/null
+++ b/include/media/as3638.h
@@ -0,0 +1,33 @@
+/* SPDX-License-Identifier: GPL-2.0 */
+/* Copyright (C) 2016 - 2018 Intel Corporation */
+
+#ifndef __AS3638_H__
+#define __AS3638_H__
+
+#define AS3638_NAME			"as3638"
+#define AS3638_I2C_ADDR			0x30
+
+#define AS3638_FLASH_MAX_BRIGHTNESS_LED1	500  /* mA, IR LED */
+#define AS3638_TORCH_MAX_BRIGHTNESS_LED1	99   /* mA, IR LED */
+#define AS3638_FLASH_MAX_BRIGHTNESS_LED2	1200 /* mA, Ultra White LED */
+#define AS3638_TORCH_MAX_BRIGHTNESS_LED2	88   /* mA, Ultra White LED */
+#define AS3638_FLASH_MAX_BRIGHTNESS_LED3	1200 /* mA, Warm White LED */
+#define AS3638_TORCH_MAX_BRIGHTNESS_LED3	88   /* mA, Warm White LED */
+
+enum as3638_led_id {
+	AS3638_LED1 = 0,
+	AS3638_LED2,
+	AS3638_LED3,
+	AS3638_LED_MAX,
+};
+#define AS3638_NO_LED -1
+
+struct as3638_platform_data {
+	int gpio_torch;
+	int gpio_strobe;
+	int gpio_reset;
+	u32 flash_max_brightness[AS3638_LED_MAX];
+	u32 torch_max_brightness[AS3638_LED_MAX];
+};
+
+#endif /* __AS3638_H__ */
diff --git a/include/media/crlmodule.h b/include/media/crlmodule.h
new file mode 100644
index 000000000..f27917d72
--- /dev/null
+++ b/include/media/crlmodule.h
@@ -0,0 +1,70 @@
+/* SPDX-License-Identifier: GPL-2.0 */
+/* Copyright (C) 2014 - 2018 Intel Corporation
+ * Generic driver for common register list based camera sensor modules
+ *
+ */
+
+#ifndef __CRLMODULE_H
+#define __CRLMODULE_H
+
+#include <media/v4l2-subdev.h>
+
+#define CRLMODULE_NAME		"crlmodule"
+
+#define CRL_MAX_CUSTOM_GPIO_AMOUNT 3
+#define CRL_MAX_GPIO_POWERUP_SEQ	4
+
+/* set this flag if this module needs serializer initialization */
+#define CRL_MODULE_FL_INIT_SER	BIT(0)
+/* set this flag if this module has extra powerup sequence */
+#define CRL_MODULE_FL_POWERUP	BIT(1)
+/* set this flag if this module needs reset signal */
+#define CRL_MODULE_FL_RESET	BIT(2)
+
+struct crl_custom_gpio {
+	char name[16];
+	int number;
+	unsigned int val;
+	unsigned int undo_val;
+};
+
+struct crlmodule_platform_data {
+	unsigned short i2c_addr;
+	unsigned short i2c_adapter;
+
+	unsigned int ext_clk;		/* sensor external clk */
+
+	unsigned int lanes;		/* Number of CSI-2 lanes */
+	const s64 *op_sys_clock;
+
+	/* specify gpio pins of Deser for PWDN, FSIN, RESET. */
+	int xshutdown;
+	int fsin;
+	int reset;
+
+	/* specify gpio pins boot timing. */
+	/* Bit 3 write 0/1 on GPIO3
+	 * Bit 2 write 0/1 on GPIO2
+	 * Bit 1 write 0/1 on GPIO1
+	 * Bit 0 write 0/1 on GPIO0
+	 */
+	char gpio_powerup_seq[CRL_MAX_GPIO_POWERUP_SEQ];
+
+	/* module_flags can be:
+	 * CRL_MODULE_FL_INIT_SER
+	 * CRL_MODULE_FL_POWERUP
+	 * CRL_MODULE_FL_RESET
+	 */
+	unsigned int module_flags;
+
+	struct crl_custom_gpio custom_gpio[CRL_MAX_CUSTOM_GPIO_AMOUNT];
+	char module_name[16]; /* module name from ACPI */
+	int crl_irq_pin;
+	unsigned int irq_pin_flags;
+	char irq_pin_name[16];
+	const char *id_string;
+	char suffix; /* suffix to identify multi sensors, abcd.. */
+	unsigned int high_framevalid_flags; /* high framevaild flags*/
+};
+
+#endif /* __CRLMODULE_H  */
diff --git a/include/media/dw9714.h b/include/media/dw9714.h
new file mode 100644
index 000000000..cf4e21a91
--- /dev/null
+++ b/include/media/dw9714.h
@@ -0,0 +1,32 @@
+/* SPDX-License-Identifier: GPL-2.0 */
+/* Copyright (C) 2015 - 2018 Intel Corporation
+ *
+ * Based on ATOMISP dw9714 implementation by
+ * Huang Shenbo <shenbo.huang@intel.com.
+ *
+ */
+
+#ifndef __DW9714_H__
+#define __DW9714_H__
+
+#include <linux/types.h>
+
+#define DW9714_NAME		"dw9714"
+
+#define DW9714_MAX_FOCUS_POS	1023
+#define DW9714_CTRL_STEPS	16 /* Keep this value power of 2 */
+#define DW9714_CTRL_DELAY_US	1000
+
+#define VCM_DEFAULT_S 0x0
+#define VCM_VAL(data, s) ((u16)((data) << 4 | (s)))
+
+struct dw9714_platform_data {
+	struct device *sensor_dev;
+	int gpio_xsd; /* Should be < 0 if not used */
+};
+
+#ifdef CONFIG_INTEL_IPU4_OV13858
+extern bool vcm_in_use;
+extern void crlmodule_vcm_gpio_set_value(unsigned int gpio, int value);
+#endif
+#endif
diff --git a/include/media/ipu-isys.h b/include/media/ipu-isys.h
new file mode 100644
index 000000000..b2acb94a1
--- /dev/null
+++ b/include/media/ipu-isys.h
@@ -0,0 +1,38 @@
+/* SPDX-License-Identifier: GPL-2.0 */
+/* Copyright (C) 2014 - 2018 Intel Corporation */
+
+#ifndef MEDIA_IPU_H
+#define MEDIA_IPU_H
+
+#include <linux/i2c.h>
+#include <linux/clkdev.h>
+
+#define IPU_ISYS_MAX_CSI2_LANES		4
+
+struct ipu_isys_csi2_config {
+	unsigned int nlanes;
+	unsigned int port;
+};
+
+struct ipu_isys_subdev_i2c_info {
+	struct i2c_board_info board_info;
+	int i2c_adapter_id;
+};
+
+struct ipu_isys_subdev_info {
+	struct ipu_isys_csi2_config *csi2;
+	struct ipu_isys_subdev_i2c_info i2c;
+	char *acpiname;
+};
+
+struct ipu_isys_clk_mapping {
+	struct clk_lookup clkdev_data;
+	char *platform_clock_name;
+};
+
+struct ipu_isys_subdev_pdata {
+	struct ipu_isys_subdev_info **subdevs;
+	struct ipu_isys_clk_mapping *clk_map;
+};
+
+#endif /* MEDIA_IPU_H */
diff --git a/include/media/ipu4-acpi.h b/include/media/ipu4-acpi.h
new file mode 100644
index 000000000..b4c361166
--- /dev/null
+++ b/include/media/ipu4-acpi.h
@@ -0,0 +1,27 @@
+/* SPDX-LIcense_Identifier: GPL-2.0 */
+/* Copyright (C) 2016 - 2018 Intel Corporation */
+
+#ifndef MEDIA_INTEL_IPU4_ACPI_H
+#define MEDIA_INTEL_IPU4_ACPI_H
+
+#include <media/ipu-isys.h>
+#include "ipu-isys.h"
+
+int ipu_get_acpi_devices(void *driver_data,
+				struct device *dev,
+				int (*fn)
+				(struct device *, void *,
+				 struct ipu_isys_csi2_config *csi2,
+				 bool reprobe));
+
+struct ipu_regulator {
+	char *src_dev_name;
+	char *src_rail;
+	char *dest_rail;
+};
+
+/* These can be override by plarform data. */
+extern const struct ipu_regulator imx230regulators[] __weak;
+extern const struct ipu_regulator ov8858regulators[] __weak;
+
+#endif
diff --git a/include/media/lc898122.h b/include/media/lc898122.h
new file mode 100644
index 000000000..5c426407b
--- /dev/null
+++ b/include/media/lc898122.h
@@ -0,0 +1,14 @@
+/* SPDX-License-Identifier: GPL-2.0 */
+/* Copyright (C) 2016 - 2018 Intel Corporation */
+
+#ifndef __LC898122_HEADER__
+#define __LC898122_HEADER__
+
+#define LC898122_VCM_ADDR	0x24
+#define LC898122_NAME		"lc898122"
+
+struct lc898122_platform_data {
+	struct device *sensor_device;
+};
+
+#endif /* __LC898122_HEADER__ */
diff --git a/include/media/lm3643.h b/include/media/lm3643.h
new file mode 100644
index 000000000..8af9ff35c
--- /dev/null
+++ b/include/media/lm3643.h
@@ -0,0 +1,50 @@
+/* SPDX-License-Identifier: GPL-2.0 */
+/* Copyright (C) 2013 - 2018 Intel Corporation */
+
+#ifndef __LM3643_H__
+#define __LM3643_H__
+
+
+#define LM3643_NAME			"lm3643"
+#define LM3643_I2C_ADDR_REVA		(0x67)
+#define LM3643_I2C_ADDR			(0x63)
+
+#define LM3643_FLASH_TOUT_DEF		0xa /*150ms*/
+
+#define LM3643_FLASH_BRT_MIN		10900
+#define LM3643_FLASH_BRT_STEP		11725
+#define LM3643_FLASH_BRT_MAX		1500000
+#define LM3643_FLASH_BRT_mA_TO_REG(a)   \
+	(((a) * 1000) < LM3643_FLASH_BRT_MIN ? LM3643_FLASH_BRT_MIN  :  \
+	((((a) * 1000) - LM3643_FLASH_BRT_MIN) / LM3643_FLASH_BRT_STEP))
+
+#define LM3643_FLASH_BRT_REG_TO_mA(a)           \
+	(((a) * LM3643_FLASH_BRT_STEP + LM3643_FLASH_BRT_MIN) / 1000)
+
+#define LM3643_FLASH_DEFAULT_BRIGHTNESS 729000
+
+#define LM3643_TORCH_BRT_MIN		 977
+#define LM3643_TORCH_BRT_STEP		 1400
+#define LM3643_TORCH_BRT_MAX		179000
+#define LM3643_TORCH_BRT_mA_TO_REG(a)   \
+	(((a) * 1000) < LM3643_TORCH_BRT_MIN ? LM3643_TORCH_BRT_MIN : \
+	((((a) * 1000) - LM3643_TORCH_BRT_MIN) / LM3643_TORCH_BRT_STEP))
+
+#define LM3643_TORCH_DEFAULT_BRIGHTNESS 89
+
+
+#define LM3643_FLASH_TOUT_MIN		0
+#define LM3643_FLASH_TOUT_STEP		1
+#define LM3643_FLASH_TOUT_MAX		15
+
+/* struct lm3643_platform_data
+ */
+struct lm3643_platform_data {
+	int gpio_torch;
+	int gpio_strobe;
+	int gpio_reset;
+	int flash_max_brightness; /*mA*/
+	int torch_max_brightness; /*mA*/
+};
+
+#endif /* __LM3643_H__ */
diff --git a/include/media/max9286.h b/include/media/max9286.h
new file mode 100644
index 000000000..68d38560a
--- /dev/null
+++ b/include/media/max9286.h
@@ -0,0 +1,53 @@
+/* SPDX-LIcense_Identifier: GPL-2.0 */
+/* Copyright (C) 2018 Intel Corporation */
+
+#ifndef MAX9286_H
+#define MAX9286_H
+
+#include <linux/i2c.h>
+#include <linux/regmap.h>
+#include <media/v4l2-common.h>
+#include <media/v4l2-ctrls.h>
+#include <media/v4l2-device.h>
+
+#define MAX9286_NAME		"max9286"
+
+#define PIXEL_ORDER_GRBG	0
+#define PIXEL_ORDER_RGGB	1
+#define PIXEL_ORDER_BGGR	2
+#define PIXEL_ORDER_GBRG	3
+
+#define NR_OF_MAX_STREAMS	4
+#define NR_OF_MAX_SOURCE_PADS	1
+#define NR_OF_MAX_SINK_PADS	4
+#define NR_OF_MAX_PADS		(NR_OF_MAX_SOURCE_PADS + NR_OF_MAX_SINK_PADS)
+
+#define MAX_PAD_SOURCE		4
+
+#define MAX9286_MIN_WIDTH	640
+#define MAX9286_MIN_HEIGHT	480
+#define MAX9286_MAX_WIDTH	1280
+#define MAX9286_MAX_HEIGHT	800
+
+struct max9286_csi_data_format {
+	u32 code;
+	u8 width;
+	u8 compressed;
+	u8 pixel_order;
+	u8 mipi_dt_code;
+};
+
+struct max9286_subdev_i2c_info {
+	struct i2c_board_info board_info;
+	int i2c_adapter_id;
+	const char suffix; /* suffix for subdevs */
+};
+
+struct max9286_pdata {
+	unsigned int subdev_num;
+	struct max9286_subdev_i2c_info *subdev_info;
+	unsigned int reset_gpio;
+	const char suffix; /* suffix for multi aggregators, abcd... */
+};
+
+#endif
diff --git a/include/media/ti960.h b/include/media/ti960.h
new file mode 100644
index 000000000..fe655c216
--- /dev/null
+++ b/include/media/ti960.h
@@ -0,0 +1,67 @@
+/* SPDX-License-Identifier: GPL-2.0 */
+/* Copyright (C) 2018 Intel Corporation */
+
+#ifndef TI960_H
+#define TI960_H
+
+#include <linux/i2c.h>
+#include <linux/regmap.h>
+#include <media/v4l2-common.h>
+#include <media/v4l2-ctrls.h>
+#include <media/v4l2-device.h>
+
+#define TI960_NAME "ti960"
+
+#define TI960_I2C_ADDRESS	0x38
+
+#define PIXEL_ORDER_GRBG	0
+#define PIXEL_ORDER_RGGB	1
+#define PIXEL_ORDER_BGGR	2
+#define PIXEL_ORDER_GBRG	3
+
+#define NR_OF_TI960_VCS_PER_SINK_PAD 2
+#define NR_OF_TI960_VCS_SOURCE_PAD 4
+#define NR_OF_TI960_SOURCE_PADS	1
+#define NR_OF_TI960_SINK_PADS	4
+#define NR_OF_TI960_PADS \
+	(NR_OF_TI960_SOURCE_PADS + NR_OF_TI960_SINK_PADS)
+/* 4port * 2vc/port * 8 stream total */
+#define NR_OF_TI960_STREAMS	\
+	(NR_OF_TI960_SINK_PADS * NR_OF_TI960_VCS_PER_SINK_PAD \
+	* NR_OF_TI960_VCS_SOURCE_PAD)
+#define NR_OF_GPIOS_PER_PORT	2
+#define NR_OF_TI960_GPIOS	\
+	(NR_OF_TI960_SINK_PADS * NR_OF_GPIOS_PER_PORT)
+
+#define TI960_PAD_SOURCE	4
+
+#define TI960_MIN_WIDTH		640
+#define TI960_MIN_HEIGHT	480
+#define TI960_MAX_WIDTH		1920
+#define TI960_MAX_HEIGHT	1080
+
+struct ti960_csi_data_format {
+	u32 code;
+	u8 width;
+	u8 compressed;
+	u8 pixel_order;
+	u8 mipi_dt_code;
+};
+
+struct ti960_subdev_info {
+	struct i2c_board_info board_info;
+	int i2c_adapter_id;
+	unsigned short rx_port;
+	unsigned short phy_i2c_addr;
+	unsigned short ser_alias;
+	const char suffix; /* suffix for subdevs */
+};
+
+struct ti960_pdata {
+	unsigned int subdev_num;
+	struct ti960_subdev_info *subdev_info;
+	unsigned int reset_gpio;
+	const char suffix;
+};
+
+#endif
diff --git a/include/media/ti964.h b/include/media/ti964.h
new file mode 100644
index 000000000..ab5ee210e
--- /dev/null
+++ b/include/media/ti964.h
@@ -0,0 +1,59 @@
+/* SPDX-License-Identifier: GPL-2.0 */
+/* Copyright (C) 2016 - 2018 Intel Corporation */
+
+#ifndef TI964_H
+#define TI964_H
+
+#include <linux/i2c.h>
+#include <linux/regmap.h>
+#include <media/v4l2-common.h>
+#include <media/v4l2-ctrls.h>
+#include <media/v4l2-device.h>
+
+#define TI964_NAME "ti964"
+
+#define PIXEL_ORDER_GRBG	0
+#define PIXEL_ORDER_RGGB	1
+#define PIXEL_ORDER_BGGR	2
+#define PIXEL_ORDER_GBRG	3
+
+#define NR_OF_TI964_STREAMS	4
+#define NR_OF_TI964_SOURCE_PADS	1
+#define NR_OF_TI964_SINK_PADS	4
+#define NR_OF_TI964_PADS \
+	(NR_OF_TI964_SOURCE_PADS + NR_OF_TI964_SINK_PADS)
+#define NR_OF_GPIOS_PER_PORT	2
+#define NR_OF_TI964_GPIOS	\
+	(NR_OF_TI964_SINK_PADS * NR_OF_GPIOS_PER_PORT)
+
+#define TI964_PAD_SOURCE	4
+
+#define TI964_MIN_WIDTH		640
+#define TI964_MIN_HEIGHT	480
+#define TI964_MAX_WIDTH		1920
+#define TI964_MAX_HEIGHT	1080
+
+struct ti964_csi_data_format {
+	u32 code;
+	u8 width;
+	u8 compressed;
+	u8 pixel_order;
+	u8 mipi_dt_code;
+};
+
+struct ti964_subdev_info {
+	struct i2c_board_info board_info;
+	int i2c_adapter_id;
+	unsigned short rx_port;
+	unsigned short phy_i2c_addr;
+	const char suffix; /* suffix for subdevs */
+};
+
+struct ti964_pdata {
+	unsigned int subdev_num;
+	struct ti964_subdev_info *subdev_info;
+	unsigned int reset_gpio;
+	const char suffix; /* suffix for multi aggregators, abcd... */
+};
+
+#endif
diff --git a/include/media/v4l2-subdev.h b/include/media/v4l2-subdev.h
index 0cbac7587..4bfeed294 100644
--- a/include/media/v4l2-subdev.h
+++ b/include/media/v4l2-subdev.h
@@ -763,6 +763,17 @@ struct v4l2_subdev_state {
  *		     this operation as close as possible to stream on time. The
  *		     operation shall fail if the pad index it has been called on
  *		     is not valid or in case of unrecoverable failures.
+ *
+ * @set_mbus_config: set the media bus configuration of a remote sub-device.
+ *		     This operations is intended to allow, in combination with
+ *		     the get_mbus_config operation, the negotiation of media bus
+ *		     configuration parameters between media sub-devices. The
+ *		     operation shall not fail if the requested configuration is
+ *		     not supported, but the driver shall update the content of
+ *		     the %config argument to reflect what has been actually
+ *		     applied to the hardware. The operation shall fail if the
+ *		     pad index it has been called on is not valid or in case of
+ *		     unrecoverable failures.
  */
 struct v4l2_subdev_pad_ops {
 	int (*init_cfg)(struct v4l2_subdev *sd,
@@ -803,8 +814,14 @@ struct v4l2_subdev_pad_ops {
 			      struct v4l2_mbus_frame_desc *fd);
 	int (*set_frame_desc)(struct v4l2_subdev *sd, unsigned int pad,
 			      struct v4l2_mbus_frame_desc *fd);
+	int (*get_routing)(struct v4l2_subdev *sd,
+			   struct v4l2_subdev_routing *route);
+	int (*set_routing)(struct v4l2_subdev *sd,
+			   struct v4l2_subdev_routing *route);
 	int (*get_mbus_config)(struct v4l2_subdev *sd, unsigned int pad,
 			       struct v4l2_mbus_config *config);
+	int (*set_mbus_config)(struct v4l2_subdev *sd, unsigned int pad,
+			       struct v4l2_mbus_config *config);
 };
 
 /**
@@ -879,6 +896,8 @@ struct v4l2_subdev_internal_ops {
  * should set this flag.
  */
 #define V4L2_SUBDEV_FL_HAS_EVENTS		(1U << 3)
+/* Set this flag if this sub-device supports substreams. */
+#define V4L2_SUBDEV_FL_HAS_SUBSTREAMS		(1U << 4)
 
 struct regulator_bulk_data;
 
diff --git a/include/media/videobuf2-v4l2.h b/include/media/videobuf2-v4l2.h
index 5a8458878..b6506081c 100644
--- a/include/media/videobuf2-v4l2.h
+++ b/include/media/videobuf2-v4l2.h
@@ -51,6 +51,7 @@ struct vb2_v4l2_buffer {
 	__s32			request_fd;
 	bool			is_held;
 	struct vb2_plane	planes[VB2_MAX_PLANES];
+	__u32			reserved;
 };
 
 /* VB2 V4L2 flags as set in vb2_queue.subsystem_flags */
@@ -72,6 +73,22 @@ struct vb2_v4l2_buffer {
  */
 struct vb2_buffer *vb2_find_buffer(struct vb2_queue *q, u64 timestamp);
 
+/**
+ * vb2_find_timestamp() - Find buffer with given timestamp in the queue
+ *
+ * @q:		pointer to &struct vb2_queue with videobuf2 queue.
+ * @timestamp:	the timestamp to find.
+ * @start_idx:	the start index (usually 0) in the buffer array to start
+ *		searching from. Note that there may be multiple buffers
+ *		with the same timestamp value, so you can restart the search
+ *		by setting @start_idx to the previously found index + 1.
+ *
+ * Returns the buffer index of the buffer with the given @timestamp, or
+ * -1 if no buffer with @timestamp was found.
+ */
+int vb2_find_timestamp(const struct vb2_queue *q, u64 timestamp,
+		       unsigned int start_idx);
+
 int vb2_querybuf(struct vb2_queue *q, struct v4l2_buffer *b);
 
 /**
-- 
2.34.1

